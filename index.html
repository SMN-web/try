<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FCM Web Push Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 12px; }
    button { margin: 6px; padding: 10px 14px; }
    pre { background: #f3f3f3; padding: 10px; white-space: pre-wrap; }
    input[type="text"] { margin: 4px 0 8px 0; width: 350px; padding: 7px; }
  </style>
</head>
<body>
  <h2>FCM Web Push Demo</h2>
  <button id="registerBtn">Register & Get Token</button>
  <input type="text" id="customMsg" placeholder="Message to send..." />
  <button id="sendBtn" disabled>Send Notification</button>
  <pre id="log"></pre>

<script>
// Replace with your Firebase Config and VAPID Key
const firebaseConfig = {
  apiKey: "AIzaSyDtZnYYDb5TR01G6zsCtrF0HBR6pnQ2Beg",
    authDomain: "general-68ca7.firebaseapp.com",
    projectId: "general-68ca7",
    storageBucket: "general-68ca7.firebasestorage.app",
    messagingSenderId: "674522865143",
    appId: "1:674522865143:web:c4ec47f2e370c33c3ca2f2",
    measurementId: "G-6L0DXHGCBE"
};
const VAPID_KEY = "BPRGTQ4CHfKjbkTBB55DgkW4Ykq5lV_UXMLje5i31lJUKD2JsNebPjdaIWqXhYNDgYtQAlcoilvEG_GmYFwxXiA";
const WORKER_API = "https://try.nafil-8895-s.workers.dev"; // e.g. https://acme-example.workers.dev

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();
let token = null;

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

document.getElementById('registerBtn').onclick = async () => {
  try {
    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
    log('âœ… SW registered');
    const perm = await Notification.requestPermission();
    log('ðŸ”” Permission: ' + perm);
    if (perm !== 'granted') return;
    token = await messaging.getToken({ 
      vapidKey: VAPID_KEY, 
      serviceWorkerRegistration: reg 
    });
    if (!token) return log("âŒ Could not get FCM token");
    log('ðŸŽ¯ Token:\n' + token);

    const resp = await fetch(WORKER_API + '/save', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token })
    });
    log("ðŸ’¾ Token saved response: " + resp.status + " - " + await resp.text());
    document.getElementById('sendBtn').disabled = false;
  } catch (e) {
    log('âŒ ' + e.message);
  }
};

document.getElementById('sendBtn').onclick = async () => {
  const msg = document.getElementById('customMsg').value || "Default Web Push Message";
  try {
    const resp = await fetch(WORKER_API + '/send', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title: "FCM Demo", body: msg })
    });
    log("ðŸ“¤ Send response: " + resp.status + " - " + await resp.text());
  } catch (e) {
    log('âŒ Send error: ' + e.message);
  }
};

// Display incoming foreground messages directly
messaging.onMessage(payload => {
  log('ðŸ’¬ Foreground message: ' + JSON.stringify(payload));
  if (payload.notification && navigator.serviceWorker) {
    navigator.serviceWorker.getRegistration().then(reg => {
      reg && reg.showNotification(payload.notification.title, {
        body: payload.notification.body,
        icon: payload.notification.icon,
        data: payload.data
      });
    });
  }
});
</script>
</body>
</html>
